
= `cargoPublish`

_cargoPublish {two-colons} AttrSet -> Effect_

Deploys package to https://www.crates.io[crates.io], the Rust community's crate repository.

Example:

```nix
effects.cargoPublish {
  secretName = "cargo-api-token";
  src = ./.;
}
```

Example secret:

```json
  "cargo-api-token": {
    "kind": "Secret",
    "data": {
      "token": "..."
    },
    "condition": {
      "and": [
        { "isOwner": "my-github-org" },
        { "isRepo": "my-site-repo" }
      ]
    }
  }
```

[[parameters]]
== `Parameters`

[[param-secretName]]
=== `secretName`

The secret that will be looked up in xref:hercules-ci-agent:ROOT:secrets-json.adoc[`secrets.json`].

The `data` field must contain a `"token"` field, with a string value that is a Cargo API token. To make one, navigate to https://crates.io/settings/tokens[API tokens] and use btn:[New Token].

[[param-extraPublishArgs]]
=== `extraPublishArgs`

Extra arguments to pass to the `cargo publish` invocation.

[[param-src]]
=== `src`

Example: `src = ./.;`

Path to the source code of the package to publish.

`src` is unpacked by the Nixpkgs https://nixos.org/manual/nixpkgs/stable/index.html#variables-controlling-the-unpack-phase[`unpackPhase`].

[[param-manifestPath]]
=== `manifestPath`

String containing the path to a `Cargo.toml`, default: `Cargo.toml`. Relative paths are relative to the unpacked `src`.

A store path subpath could be passed instead, bypassing `unpackPhase`.

[[param-registryURL]]
=== `registryURL`

Optional registry to publish to. Defaults to cargo's default behavior, which is to publish to https://doc.rust-lang.org/cargo/reference/manifest.html#the-publish-field[`package.publish`] or crates.io.

If you use an alternate registry or private registry, you are recommended to store this information in `Cargo.toml`.

Note that this must be the backing git repository URL, not a web or API URL.

[[param-dryRun]]
=== `dryRun`

Boolean, default `false`. When `true`, runs `cargo publish --dry-run` which packages and verifies the crate(s) without uploading.

When `dryRun` is `true`, the `secretName` is not required.

[[param-assertVersions]]
=== `assertVersions`

Verify package versions before publishing. This can be:

* An empty attribute set `{}` (default): no version checking
* A string like `"1.0.0"`: check that all packages in the workspace have this version
* An attribute set mapping package names to versions: `{ my-crate = "1.0.0"; }`

Example for workspace with synchronized versions:

```nix
effects.cargoPublish {
  src = ./.;
  secretName = "cargo-api-token";
  assertVersions = "1.0.0";  # All packages must be version 1.0.0
}
```

// Keep in sync with: ../flake-parts/cargo-publish.adoc#rate-limits
[[rate-limits]]
== Rate Limits

When publishing a workspace with many crates for the first time, you may hit crates.io rate limits. The registry limits new crate registrations more strictly than updates to existing crates. At the time of writing, crates.io allows a burst of about 5 new packages, then requires a wait of approximately 10 minutes before publishing more.

If you encounter rate limit errors during an initial release:

1. Wait for the rate limit to reset (approximately 10 minutes)
2. Use `extraPublishArgs` to publish remaining crates individually:
+
```nix
effects.cargoPublish {
  src = ./.;
  secretName = "cargo-api-token";
  extraPublishArgs = [ "--package" "my-unpublished-crate" ];
}
```
3. Run locally with `hci effect run` to iterate through remaining crates:
+
```shell
hci effect run onPush.default.effects.cargo-publish --pretend-ref refs/tags/0.1.0
```

After the initial release, subsequent version updates are less likely to hit rate limits.

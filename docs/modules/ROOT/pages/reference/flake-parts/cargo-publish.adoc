
# `hercules-ci.cargo-publish`

The https://flake.parts/options/hercules-ci-effects.html#opt-hercules-ci.cargo-publish.enable[options] in `hercules-ci.cargo-publish` automate publishing Rust crates to https://crates.io[crates.io] or a custom registry.

In its default configuration, this will run `cargo publish --dry-run` on every branch push, and perform an actual publish when a tag is pushed.

## Complete Example

```nix
{
  description = "A Rust project with automated publishing";

  inputs = {
    nixpkgs.url = "github:NixOS/nixpkgs/nixos-unstable";
    hercules-ci-effects.url = "github:hercules-ci/hercules-ci-effects";
  };

  outputs = inputs@{ self, flake-parts, ... }:
    flake-parts.lib.mkFlake { inherit inputs; } {
      imports = [
        inputs.hercules-ci-effects.flakeModule
      ];
      systems = [ "x86_64-linux" ];
      hercules-ci.cargo-publish = {
        enable = true;
        secretName = "crates-io";
        assertVersions = true;  # Check all packages match the tag version
      };
    };
}
```

// Keep in sync with: ../nix-functions/cargoPublish.adoc#rate-limits
## Rate Limits

When publishing a workspace with many crates for the first time, you may hit crates.io rate limits. The registry limits new crate registrations more strictly than updates to existing crates. At the time of writing, crates.io allows a burst of about 5 new packages, then requires a wait of approximately 10 minutes before publishing more.

If you encounter rate limit errors during an initial release:

1. Wait for the rate limit to reset (approximately 10 minutes)
2. Use `extraPublishArgs` to publish remaining crates individually:
+
```nix
hercules-ci.cargo-publish = {
  enable = true;
  secretName = "crates-io";
  extraPublishArgs = [ "--package" "my-unpublished-crate" ];
};
```
3. Run locally with `hci effect run` to iterate through remaining crates:
+
```shell
hci effect run onPush.default.effects.cargo-publish --pretend-ref refs/tags/0.1.0
```

After the initial release, subsequent version updates are less likely to hit rate limits.

See also

* xref:reference/nix-functions/cargoPublish.adoc[`cargoPublish`] function reference for more options
* https://flake.parts/options/hercules-ci-effects.html#opt-hercules-ci.cargo-publish.enable[`hercules-ci.cargo-publish`] options reference
* https://flake.parts/getting-started.html[Getting Started] with flake-parts
